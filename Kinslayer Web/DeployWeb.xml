<project name="build kinslayermud" default="build" basedir=".">

	<property name="tomcat-home" value=""/>
	<property name="tomcat-bin" value="${tomcat-home}/bin"/>
	<property name="web-root" value=""/>
	<property name="web-webinf" value="${web-root}/WEB-INF"/>
	<property name="web-classes" value="${web-webinf}/classes"/>
	<property name="web-lib" value="${web-webinf}/lib"/>
	<property name="web-view" value="${web-root}/View"/>
	<property name="checkout-root" value="Kinslayer Web"/>
	<property name="checkout-src" value="${checkout-root}/src"/>
	<property name="checkout-webinf" value="${checkout-root}/WebContent/WEB-INF"/>
	<property name="checkout-lib" value="${checkout-webinf}/lib/"/>
	<property name="checkout-classes" value="${checkout-webinf}/classes"/>
	<property name="checkout-view" value="${checkout-root}/View"/>
	<property name="checkout-shared-root" value="Kinslayer Shared"/>
	<property name="checkout-shared-src" value="${checkout-shared-root}/src"/>

	<property name="branch" value="trunk" />
	<property name="revision" value="" />
	
	<path id="classpath">
		<fileset dir="${checkout-lib}">
			<include name="**/*.jar"/>
		</fileset>
	</path>
	
	<target name="build" depends="svn-cleanup,svn-checkout,consolidate-projects,compile-web,stop-tomcat,inject-updates,spawn-tomcat" />
	<target name="svn-cleanup">
		<delete dir="${checkout-root}" />
		<delete dir="${checkout-shared-root}" />
	</target>

	<target name="svn-checkout">
		<exec dir="." executable="svn">
			<arg line="checkout http://localhost/svn/kmud-live/${branch}/Kinslayer%20Web${revision} --username=mmason --password='W@qsablast'" />
		</exec>
		<exec dir="." executable="svn">
			<arg line="checkout http://localhost/svn/kmud-live/${branch}/Kinslayer%20Shared${revision} --username=mmason --password='W@qsablast'" />
		</exec>
	</target>
	
	<target name="compile-web">
		<mkdir dir="${checkout-classes}"/>
		<javac srcdir="${checkout-src}" destdir="${checkout-classes}" classpathref="classpath">
			<include name="**/*.java"/>
		</javac>
		
		<copy file="${checkout-src}/struts.xml" todir="${checkout-classes}">
		</copy>
	</target>

	<target name="stop-tomcat">
		<echo>
			Stopping tomcat.
		</echo>
		<exec dir="." executable="${tomcat-bin}/shutdown.sh"/>
		<echo>
			Pausing to give tomcat opportunity to shut down.
		</echo>
		<sleep seconds="5" />
	</target>

	<target name="inject-updates">
		<delete dir="${web-root}"/>
		<mkdir dir="${web-root}"/>

		<mkdir dir="${web-webinf}"/>

		<!--
		<copy file="${checkout-root}/index.jsp" todir="/var/www-dev" failonerror="false" />
		-->
		<copy file="${checkout-root}/.htaccess" todir="${web-root}/../" failonerror="false" />

		<copy todir="${web-view}">
			<fileset dir="${checkout-view}"/>
		</copy>
		
		<!--
		<copydir src="${checkout-view}" dest="${web-view}" />
		-->
		<!--
		<copy file="${checkout-root}/index.jsp" todir="${web-root}" />
		-->
		<copy todir="${web-webinf}">
			<fileset dir="${checkout-webinf}"/>
		</copy>
	</target>
	
	<target name="consolidate-projects">
		<!-- Move source files over -->
		<copy todir="${checkout-src}/org/kinsalyermud/">
			<fileset dir="${checkout-shared-src}/org/kinslayermud/"/>
		</copy>

		<!-- Move jar files over -->
		<copy todir="${checkout-lib}" flatten="true">
			<fileset dir="${checkout-shared-root}">
				<include name="**/*.jar"/>
			</fileset>
		</copy>
	</target>
	
	<target name="spawn-tomcat">
		<echo>
			Spawning new tomcat instance.
		</echo>
		<exec dir="." executable="${tomcat-bin}/startup.sh"/>

		<echo>
			Pausing to give tomcat opportunity to start.
		</echo>

		<sleep seconds="10" />
			
		<antcall target="svn-cleanup" />
	</target>
	
</project>
